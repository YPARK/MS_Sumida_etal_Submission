---
title: "Can we identify clonal effects?"
author: Yongjin Park
theme: jekyll-theme-minimal
date: "`r Sys.Date()`"
bibliography: "reference.bib"
---

```{r GlobOpt, include=FALSE}
fig.dir = 'Fig/STEP7/'
knitr::opts_knit$set(eval.after = 'fig.cap')
knitr::opts_chunk$set(warning = FALSE, message = FALSE, fig.path = fig.dir)
knitr::opts_chunk$set(fig.width=8, fig.height=8)
options(stringsAsFactors = FALSE)
FIG.CAP = '**Fig.**'

library(tidyverse)
library(data.table)
library(patchwork)
source("Util-rmd.R")
.mkdir(fig.dir)
```


1. DEG analysis between expanded (double/triple/multiple) vs
   non-expanded in HC mTreg and also in MS mTreg. -> check if PRDM1
   upregulation in pseudo-bulk is simply by containing expanded cells.

2. If first point is true, we can confirm if we still see PRDM1 as
   DEGs even after removing expanded cells in pseudo-bulk DE analysis
   between HC vs MS.  -> If disease (MS) is a key factor driving
   PRDM1, PRDM1 will survive.

3. Clonal sharing among mTreg and mTconv subsets




```{r}
tcr.dt <- fread("data/MS_Treg_Clonality/step2_umap_share_tcrs.txt")

annot.dt <- fread("result/step2/assignment/round1.annot.gz",
                  header=FALSE, col.names = c("tag","ct","prob","ln.prob"))

annot.dt <- annot.dt[, c("barcode","batch") := tstrsplit(`tag`,split="_")]

## hash.dt <- fread("data/hashtag.tsv.gz", header=TRUE)

.temp <- fread("data/hashtag.tsv.gz", header=TRUE)

hash.dt <- fread("data/cell_info_batch3-7.csv.gz") %>%
    rename(barcode = cell)


.temp2 <-
    .temp[, .(barcode, batch, disease, hash)] %>%
    left_join(hash.dt, by = c("barcode", "batch"))




full.dt <- annot.dt %>%
    mutate(batch = as.integer(batch)) %>% 
    left_join(hash.dt, by = c("barcode", "batch")) %>% 
    left_join(tcr.dt, by = c("barcode", "batch"))


 %>%
    na.omit() %>% 
    filter(ct == celltype) %>% ## get rid of unstable cell types
    mutate(cte = ct %&% "_" %&% gsub(" ", "", Expanded)) %>%
    as.data.table

```


```{r}
library(mmutilR)
mtx.data <- fileset.list("result/step1/matrix_final")

.cocoa <- make.cocoa(mtx.data,
                     celltype = full.dt[, .(tag, cte)],
                     cell2indv = full.dt[, .(tag, subject)],
                     indv2exp = unique(full.dt[, .(subject, disease)]),
                     knn=100, .em.iter=10, num.threads = 16)

.pine <- make.pine(mtx.data,
                   celltype = full.dt[, .(tag, cte)],
                   cell2indv = full.dt[, .(tag, subject)],
                   knn=100, .em.iter=10, num.threads = 16)


```



```{r}


head(rownames(.cocoa$resid.ln.mu))


xx <- t(.cocoa$resid.ln.mu["PRDM1", , drop = FALSE])
yy <- t(.cocoa$resid.ln.mu.sd["PRDM1", , drop = FALSE])

.dt <- data.table(xx, sd = yy, r = rownames(xx))
.dt[, c("subject", "celltype", "expanded") := tstrsplit(`r`, split="_")]
.dt <- .dt %>%
    na.omit() %>%
    filter(subject != "NA") %>%
    mutate(disease = substr(`subject`, 1, 2)) %>%
    group_by(expanded, celltype) %>%
    mutate(PRDM1 = PRDM1 - mean(PRDM1)) %>% 
    ungroup()

.aes <- aes(subject, PRDM1,
            ymin = PRDM1 - sd.PRDM1,
            ymax = PRDM1 + sd.PRDM1,
            fill = disease,
            shape = expanded)

plt <-
    ggplot(.dt, .aes) +
    theme_bw() +
    theme(axis.text.x=element_text(angle=90, vjust=1, hjust=1)) +
    facet_wrap(~ expanded + celltype, scales="free", nrow=2) +
    geom_hline(yintercept = 0, size=.5, color="gray", lty=2) +
    geom_linerange(size=.2) +
    geom_point(stroke=.2) +
    scale_shape_manual(values = c(22, 21))

ggsave("temp.pdf", plt, width=8, height=5) 
```
