---
title: "Step 2: cell type annotation"
date: "`r Sys.Date()`"
author: Yongjin Park
bibliography: "MS_Ref.bib"
output:
  html_document:
    toc: true
    keep_md: true
    self_contained: true
---


```{r GlobOpt, include = FALSE}
fig.dir = 'Fig/STEP2/'
dir.create(fig.dir, recursive = TRUE, showWarnings = FALSE)
knitr::opts_knit$set(eval.after = 'fig.cap')
knitr::opts_chunk$set(warning = FALSE, message = FALSE, fig.path = fig.dir)
knitr::opts_chunk$set(fig.width=8, fig.height=8)
options(stringsAsFactors = FALSE)
FIG.CAP = '**Fig.**'
library(data.table)
library(dplyr)
library(patchwork)
library(mmutilR)
library(Matrix)
source("Util-rmd.R")
source("Util-alg.R")
```

```{r echo = FALSE}
.read.marker.file <- function(.file){
    x <- fread(.file, header=F, col.names=c("feat","ct"))
    .xx <- x[, .(feat=list(feat)), by = .(ct)];
    .ret <- .xx$feat; names(.ret) <- .xx$ct;
    .ret
}
```

```{r}
.hdr <- "result/step1/final_matrix"
.data <- fileset.list(.hdr)
```

## 0. Surface Marker Proteins

* nTconv : CD3+, CD4+, CD8-, CD25-/CD127+, CD45RA+/CD45RO-
* mTconv : CD3+, CD4+, CD8-, CD25-/CD127+, CD45RA-/CD45RO+
* nTreg : CD3+, CD4+, CD8-, CD25+/CD127-, CD45RA+/CD45RO-
* mTreg : CD3+, CD4+, CD8-, CD25+/CD127-, CD45RA-/CD45RO+

```{r include = F}
.pos.markers <- .read.marker.file("marker/surface_round1_positive.txt")
.neg.markers <- .read.marker.file("marker/surface_round1_negative.txt")

.mkdir("result/step2")
.marker.hdr <- "result/step2/marker"
.marker.data <- fileset.list(.marker.hdr)

if.needed(.marker.data, {
    .markers <- unique(c(unlist(.pos.markers),
                         unlist(.neg.markers)))
    .marker.data <-
        rcpp_mmutil_copy_selected_rows(.data$mtx,
                                       .data$row,
                                       .data$col,
                                       .markers,
                                       .marker.hdr)
})
```

## 1. Adjust batch-specific displacement using Batch-balancing k-Nearest Neighbour graph

```{r run_bbknn_before_annotation}
.file <- "result/step2/bbknn.rds"
.mkdir(dirname(.file))

if.needed(.file, {

    .cells <-
        fread(.data$col, header=F, col.names = "tag") %>%
        parse.tag()

    .svd <- rcpp_mmutil_svd(.data$mtx, RANK=50, TAKE_LN=T, EM_ITER = 20, NUM_THREADS=16)

    .bbknn <- rcpp_mmutil_bbknn(r_svd_v = .svd$V,
                                r_svd_u = .svd$U,
                                r_svd_d = .svd$D,
                                r_batches = .cells$batch,
                                knn = 50,
                                NUM_THREADS = 16,
                                USE_SINGULAR_VALUES = F)

    saveRDS(.bbknn, .file)
})

.bbknn <- readRDS(.file)
```

```{r annotation_with_bbknn}
.file <- "result/step2/annotation_bbknn.txt.gz"
if.needed(.file, {

    .annot.out <-
        rcpp_mmutil_annotate_columns(
            pos_labels = list(p1=.pos.markers),
            r_neg_labels = list(n1=.neg.markers),
            r_U = .bbknn$U,
            r_D = .bbknn$D,
            r_V = .bbknn$factors.adjusted,
            row_file = .data$row,
            col_file = .data$col,
            EM_TOL = 1e-8,
            EM_ITER = 500,
            TAKE_LN = F)

    .col <- c("tag", "celltype", "prob", "ln.prob")
    names(.annot.out$annotation) <- .col
    annot.dt <- setDT(.annot.out$annotation) %>%
        parse.tag()

    fwrite(annot.dt, .file)
})
```

## 2. Make major cell type annotation based on marker proteins + Leiden clustering

```{r refine_annotation_by_leiden}
.file <- "Tab/step2_cell_type.txt.gz"
if.needed(.file, {
    .cells <-
        fread(.data$col, header=F, col.names = "tag") %>%
        parse.tag()

    .leiden <- run.leiden(.bbknn$knn.adj, .cells$tag, res=1, nrepeat = 100)

    .tab <-
        .leiden %>% 
        left_join(annot.dt) %>%
        na.omit()

    ## identify problematic clusters
    .fraction <- .tab[, .(.N), by = .(celltype, membership, component)]
    .fraction[, Ntot := sum(`N`), by = .(membership, component)]
    .mem.qc <- .fraction[order(`N`, decreasing = T), head(.SD, 1), by = .(membership, component)]

    .remove <- .mem.qc[`N` / `Ntot` < .5, .(membership, component)]

    ## Map cell group membership to cell type
    .ct.map <- .mem.qc[, .(membership, component, celltype)]

    final.cell.type <- .leiden %>%
        anti_join(.remove) %>%
        na.omit() %>% 
        left_join(.ct.map) %>%
        as.data.table() %>%
        parse.tag()
    fwrite(final.cell.type, .file)
})
final.cell.type <- fread(.file)
```

```{r calculate_umap_coordinates}
.file <- "Tab/step2_umap_coord.txt.gz"
if.needed(.file, {
    .umap <- uwot::tumap(.bbknn$factors.adjusted,
                         learning_rate = .1,
                         n_epochs = 2000,
                         n_sgd_threads = 16,
                         init = "laplacian",
                         verbose = T,
                         init_sdev = .01,
                         scale = F)

    .tags <- readLines(.data$col)
    colnames(.umap) <- "UMAP" %&% 1:ncol(.umap)
    umap.dt <- data.table(.umap, tag = .tags)
    fwrite(umap.dt, .file)
})
umap.dt <- fread(.file) %>% 
    left_join(final.cell.type) %>% 
    na.omit()
```

```{r calculate_tsne_coordinates}
.file <- "Tab/step2_tsne_coord.txt.gz"
if.needed(.file, {
    .tsne <- Rtsne::Rtsne(.bbknn$factors.adjusted,
                          num_threads = 16,
                          verbose = T,
                          check_duplicates = F)

    .tags <- readLines(.data$col)
    colnames(.tsne$Y) <- "tSNE" %&% 1:ncol(.tsne$Y)
    tsne.dt <- data.table(.tsne$Y, tag = .tags)
    fwrite(tsne.dt, .file)
})
tsne.dt <- fread(.file) %>%
    left_join(final.cell.type) %>%
    na.omit()
```

### t-UMAP

```{r Fig_umap_celltype, fig.width=9, fig.height=5}
p1 <- .gg.plot(umap.dt[sample(.N)], aes(UMAP1, UMAP2, color=celltype)) +
    ggrastr::rasterise(geom_point(stroke = 0, size=1), dpi=300) +
    theme(legend.position = c(0,0), legend.justification = c(0,0)) +
    ggtitle("cell types") +
    scale_color_brewer("", palette = "Paired")

p2 <- .gg.plot(umap.dt[sample(.N)], aes(UMAP1, UMAP2, color=as.factor(batch))) +
    ggrastr::rasterise(geom_point(stroke = 0, size=1), dpi=300) +
    theme(legend.position = c(0,0), legend.justification = c(0,0)) +
    ggtitle("batch membership") +
    scale_color_brewer("", palette = "Set3")

p3 <- .gg.plot(umap.dt[sample(.N)], aes(UMAP1, UMAP2, color=as.factor(membership))) +
    ggrastr::rasterise(geom_point(stroke = 0, size=1), dpi=300) +
    theme(legend.position = c(0,0), legend.justification = c(0,0)) +
    ggtitle("clustering") +
    scale_color_brewer("", palette = "Set1")

plt <- p1 | p2 | p3
print(plt)
```


```{r results="asis", echo=F}
.file <- fig.dir %&% "/Fig_umap_celltype.pdf"
.gg.save(filename = .file, plot = plt, width=9, height=5)
```

### tSNE

```{r Fig_tsne_celltype, fig.width=9, fig.height=3}
p1 <-
    .gg.plot(tsne.dt[sample(.N)], aes(tSNE1, tSNE2, color=celltype)) +
    ggrastr::rasterise(geom_point(stroke = 0, size=1), dpi=300) +
    theme(legend.position = c(0,0), legend.justification = c(0,0)) +
    ggtitle("cell types") +
    scale_color_brewer("", palette = "Paired")

p2 <-
    .gg.plot(tsne.dt[sample(.N)], aes(tSNE1, tSNE2, color=as.factor(batch))) +
    ggrastr::rasterise(geom_point(stroke = 0, size=1), dpi=300) +
    theme(legend.position = c(0,0), legend.justification = c(0,0)) +
    ggtitle("batch membership") +
    scale_color_brewer("", palette = "Set3")

p3 <-
    .gg.plot(tsne.dt[sample(.N)], aes(tSNE1, tSNE2, color=as.factor(membership))) +
    ggrastr::rasterise(geom_point(stroke = 0, size=1), dpi=300) +
    theme(legend.position = c(0,0), legend.justification = c(0,0)) +
    ggtitle("clustering") +
    scale_color_brewer("", palette = "Set1")

plt <- p1 | p2 | p3
print(plt)
```

```{r results="asis", echo=F}
.file <- fig.dir %&% "/Fig_tsne_celltype.pdf"
.gg.save(filename = .file, plot = plt, width=9, height=3)
```

## 3. Confirm cell type assignment with raw surface marker proteins

```{r constrcut_marker_matrix, echo = FALSE}
marker.raw.mtx <- read.dense(.marker.data$mtx)
.names <- sapply(readLines(.marker.data$row),
                 function(s) unlist(strsplit(s, split="[_]+"))[1],
                 USE.NAMES = F)

rownames(marker.raw.mtx) <- .names
colnames(marker.raw.mtx) <- readLines(.marker.data$col)

.melt <-
    reshape2::melt(marker.raw.mtx) %>%
    filter(!str_detect(`Var1`, "Hashtag")) %>%
    as.data.table()

.sum <- .melt[,
              .(value = sum(value)),
              by = .(Var1, Var2)]

## collapse the same feature names
.dt <-
    dcast(.sum, Var1 ~ Var2, value.var = "value", fill = 0)

marker.raw.mtx <- as.matrix(.dt[, -1])
rownames(marker.raw.mtx) <- unlist(.dt[, 1])
```

Two-dimensional density plot on the raw CD marker concentrations.

```{r Fig_cdmarker_raw, fig.width=6, fig.height=5}
.ct <- c("mTreg","nTreg","mTconv","nTconv")
plt <- plt.scatter.ct.2(.ct, final.cell.type, marker.raw.mtx)
print(plt)
```

```{r results="asis", echo=F}
.file <- fig.dir %&% "/Fig_cdmarker_raw.pdf"
.gg.save(filename = .file, plot = plt, width=6, height=5)
```


## 4. Confirm by other marker genes/proteins (normalized expression)

```{r}
.markers <-
    c("FOXP3", "ID3", "BACH2", "CXCR3", "PRDM1", "SGK1", "TCF7", "LEF1",
      "SELL", "IL2RA", "IL7R", "IKZF2", "CCR6", "CCR4", "CCR7", "CTLA4",
      "HLA-DRA", "CD25", "CD127", "CD183", "CD196",
      "CD197", "CD194", "CD45RA", "CD45RO",
      "HLA") %>%
    unique
```

```{r include = F}
.ct <- c("mTreg","nTreg","mTconv","nTconv")

marker.dt <-
    t(bbknn.x(.data, .bbknn, .markers, .rescale=F)) %>%
    as.data.frame() %>%
    rownames_to_column("tag") %>%
    left_join(umap.dt[, .(tag, UMAP1, UMAP2)]) %>%
    left_join(tsne.dt[, .(tag, tSNE1, tSNE2)]) %>%
    left_join(final.cell.type[, .(tag, celltype)]) %>%
    na.omit() %>%
    as.data.table() %>%
    melt(id.vars = c("tag", "UMAP1", "UMAP2", "tSNE1", "tSNE2", "celltype"),
         variable.name = "marker",
         value.name = "expr") %>%
    mutate(celltype = factor(celltype, .ct)) %>%
    as.data.table()

plot.marker.scatter <- function(.marker, show.tsne = F) {

    .dt <- marker.dt[marker == .marker]
    ## handle outliers for better visualization
    .cutoff <- quantile(.dt$expr, probs = .95, na.rm=TRUE)

    .aes <- aes(x = UMAP1, y = UMAP2, colour = exp(expr))
    if(show.tsne){
        .aes <- aes(x = tSNE1, y = tSNE2, colour = exp(expr))
    }
    .dt <- .dt %>%
        mutate(expr = scale(pmin(expr, .cutoff))) %>%
        arrange(expr)
    ret <-
        ggplot(.dt, .aes) +
        ggtitle(.marker) +
        theme_classic() +
        ggrastr::rasterise(geom_point(stroke=.0, size=.7, alpha=.8), dpi=300) +
        theme(legend.key.width = unit(.2, "lines"),
              legend.key.height = unit(.5, "lines"),
              legend.position = c(1,1),
              legend.justification = c(1,1),
              legend.title = element_text(size=6),
              legend.text = element_text(size=5)) +
        scale_colour_distiller("", palette="RdPu", direction=1)

    return(ret)
}
```

### UMAP for the marker genes and proteins

```{r Fig_marker_umap, fig.width=3, fig.height=5, results="asis"}
.markers <- sort(as.character(unique(marker.dt$marker)))
for(g in .markers){
    plt <- plot.marker.scatter(g, show.tsne = F)
    print(plt)
    .file <- fig.dir %&% "/Fig_marker_" %&% g %&% "_umap.pdf"
    .gg.save(filename = .file, plot = plt, width=3, height=5)
}
```

### tSNE for the marker genes and proteins

```{r Fig_marker_tsne, fig.width=3, fig.height=3, results="asis"}
.markers <- sort(as.character(unique(marker.dt$marker)))
for(g in .markers){
    plt <- plot.marker.scatter(g, show.tsne = T)
    print(plt)
    .file <- fig.dir %&% "/Fig_marker_" %&% g %&% "_tsne.pdf"
    .gg.save(filename = .file, plot = plt, width=3, height=3)
}
```

## 5. Basic statistics for the first round annotation (`r num.int(nrow(final.cell.type))` cells)

```{r include=FALSE}
.sum.stat.batch <- function(.dt) {
    .dt %>%
        group_by(batch, disease) %>%
        mutate(P = 100 * N/sum(N)) %>%
        arrange(desc(ct)) %>%
        mutate(Pc = cumsum(P)) %>%
        ungroup() %>%
        group_by(batch) %>%
        mutate(nb = sum(N)) %>%
        ungroup() %>%
        mutate(batch = "#" %&% batch %&% " (N=" %&% num.int(nb) %&% ")")
}
.sum.stat.tot <- function(.dt) {
    .dt %>%
        group_by(disease) %>%
        mutate(P = 100 * N/sum(N)) %>%
        arrange(desc(ct)) %>%
        mutate(Pc = cumsum(P)) %>%
        ungroup()
}
.plt.sum.stat <- function(.stat) {
    .gg.plot(.stat, aes(x=disease, y=P, group=ct, fill=celltype)) +
        facet_grid(.~batch) +
        geom_bar(stat="identity") +
        geom_text(aes(y=Pc, label=num.int(N)), size=2) +
        scale_fill_brewer(palette="Paired") +
        ylab("cell type composition (%)") +
        theme(legend.title=element_blank())
}
```

```{r}
.hash.hdr <- "result/step1/hash"
.hash.data <- fileset.list(.hash.hdr)
.hash.info <- read.hash(.hash.data)
```

```{r Fig_count_stat_tot, fig.height=3, fig.width=6, echo = FALSE, results="asis"}
.ct <- c("mTreg","nTreg","mTconv","nTconv")

.dt <- final.cell.type %>%
    left_join(.hash.info) %>%
    mutate(ct = factor(celltype, .ct))

.stat <-
    .dt[,
        .(N = .N),
        by=.(batch, celltype, ct, disease)] %>%
    .sum.stat.batch

plt <- .plt.sum.stat(.stat) +
    ggtitle("Profiled on all the samples")
print(plt)
```

```{r results="asis", echo=F}
.file <- fig.dir %&% "/Fig_count_stat_tot.pdf"
.gg.save(filename = .file, plot = plt, height=3, width=6)
```

```{r Fig_count_merged_stat_tot, fig.height=3, fig.width=2.2, echo = FALSE, results="asis"}
.stat.tot <-
    .dt[,
        .(N = .N),
        by=.(celltype, ct, disease)] %>%
    .sum.stat.tot %>%
    mutate(batch = "(N=" %&% num.int(sum(.stat$N)) %&% ")")
plt <- .plt.sum.stat(.stat.tot) +
    ggtitle("Profiled on all the samples")
print(plt)
```

```{r results="asis", echo=F}
.file <- fig.dir %&% "/Fig_count_merged_stat_tot.pdf"
.gg.save(filename = .file, plot = plt, height=3, width=2.2)
```


## 6. PRDM1 short vs. long

```{r include = FALSE}
prdm.thm <-
    theme_classic() +
    theme(legend.key.width = unit(.2, "lines"),
          legend.key.height = unit(.5, "lines"),
          legend.title = element_text(size=6),
          legend.text = element_text(size=5),
          legend.position = c(0,0),
          legend.justification = c(0,0))
```

```{r incldue = FALSE}
prdm.dt <- fread("data/PRDM1/PRDM1_SL.csv.gz")

.dt <-
    copy(final.cell.type) %>%
    left_join(prdm.dt) %>%
    left_join(umap.dt) %>%
    left_join(tsne.dt) %>%
    na.omit() %>%
    as.data.table()

.dt[, membership := as.factor(`membership`)]
```

```{r Fig_PRDM1_isoform_umap, fig.width=6, fig.height=5}
.aes <- aes(UMAP1, UMAP2, colour=pmin(PRDM1_short, 3))

p1 <-
    ggplot(.dt[order(PRDM1_short)], .aes) +
    xlab("UMAP 1") + ylab("UMAP 2") + prdm.thm +
    ggrastr::rasterise(geom_point(stroke=0, size=1), dpi = 300) +
    scale_colour_distiller("PRDM1\nshort",
                           palette="RdPu",
                           direction=1)

.aes <- aes(UMAP1, UMAP2, colour = pmin(PRDM1_long, 3))

p2 <-
    ggplot(.dt[order(PRDM1_long)], .aes) +
    xlab("UMAP 1") + ylab("UMAP 2") + prdm.thm +
    ggrastr::rasterise(geom_point(stroke=0, size=1), dpi = 300) +
    scale_colour_distiller("PRDM1\nlong",
                           palette="RdPu",
                           direction=1)

plt <- p1 | p2
print(plt)
```

```{r results="asis", echo=FALSE}
.file <- fig.dir %&% "/Fig_PRDM1_isoform_umap.pdf"
.gg.save(filename = .file, plot = plt, width=6, height=5)
```

```{r Fig_PRDM1_isoform_tsne, fig.width=6, fig.height=3}
.aes <- aes(tSNE1, tSNE2, colour=pmin(PRDM1_short, 3))

p1 <-
    ggplot(.dt[order(PRDM1_short)], .aes) +
    xlab("tSNE 1") + ylab("tSNE 2") + prdm.thm +
    ggrastr::rasterise(geom_point(stroke=0, size=1), dpi = 300) +
    scale_colour_distiller("PRDM1\nshort",
                           palette="RdPu",
                           direction=1)

.aes <- aes(tSNE1, tSNE2, colour = pmin(PRDM1_long, 3))

p2 <-
    ggplot(.dt[order(PRDM1_long)], .aes) +
    xlab("tSNE 1") + ylab("tSNE 2") + prdm.thm +
    ggrastr::rasterise(geom_point(stroke=0, size=1), dpi = 300) +
    scale_colour_distiller("PRDM1\nlong",
                           palette="RdPu",
                           direction=1)

plt <- p1 | p2
print(plt)
```

```{r results="asis", echo=FALSE}
.file <- fig.dir %&% "/Fig_PRDM1_isoform_tsne.pdf"
.gg.save(filename = .file, plot = plt, width=6, height=3)
```

## 5. Tables

```{r results="asis", echo=F}
cat("* [**DOWNLOAD:** Cell type annotation](Tab/step2_cell_type.txt.gz)\n\n")

cat("* [**DOWNLOAD:** UMAP + annotation](Tab/step2_umap_coord.txt.gz)\n\n")

cat("* [**DOWNLOAD:** tSNE + annotation](Tab/step2_tsne_coord.txt.gz)\n\n")
```

